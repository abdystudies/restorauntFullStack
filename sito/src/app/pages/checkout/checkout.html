<div class="checkout-container">
  <!-- Confermazione Ordine -->
  <div class="order-confirmation" *ngIf="orderPlaced">
    <div class="confirmation-content">
      <div class="success-icon">‚úì</div>
      <h1>Ordine Confermato!</h1>
      <p class="confirmation-message">Grazie per il tuo ordine. Riceverai una notifica quando il tuo cibo sar√† pronto per la consegna.</p>
      
      <div class="order-details">
        <div class="detail-row">
          <span>Numero Ordine:</span>
          <strong>#{{ orderConfirmation.id.substring(0, 8) }}</strong>
        </div>
        <div class="detail-row">
          <span>Importo Totale:</span>
          <strong>‚Ç¨{{ orderConfirmation.totalPrice.toFixed(2) }}</strong>
        </div>
        <div class="detail-row">
          <span>Tempo Stimato:</span>
          <strong>30 minuti</strong>
        </div>
      </div>

      <button (click)="router.navigate(['/order'])" class="btn-primary">
        Continua a Ordinare
      </button>
    </div>
  </div>

  <!-- Form Checkout -->
  <div class="checkout-content" *ngIf="!orderPlaced">
    <header class="checkout-header">
      <h1>üõçÔ∏è Completa il tuo ordine</h1>
      <p>Inserisci i dettagli di consegna e pagamento</p>
    </header>

    <!-- Errore -->
    <div class="error-message" *ngIf="errorMessage">
      <span>‚ö†Ô∏è {{ errorMessage }}</span>
    </div>

    <div class="checkout-grid">
      <!-- Colonna Sinistra: Form -->
      <div class="checkout-form-section">
        <form [formGroup]="checkoutForm">
          <!-- Dati Personali -->
          <fieldset class="form-section">
            <legend>üë§ Dati Personali</legend>

            <div class="form-group">
              <label for="fullName">Nome Completo</label>
              <input
                id="fullName"
                type="text"
                formControlName="fullName"
                placeholder="Es. Mario Rossi"
                class="form-input"
                [class.error]="checkoutForm.get('fullName')?.invalid && checkoutForm.get('fullName')?.touched"
              />
              <span class="error-text" *ngIf="checkoutForm.get('fullName')?.invalid && checkoutForm.get('fullName')?.touched">
                {{ getFieldError('fullName') }}
              </span>
            </div>

            <div class="form-group">
              <label for="email">Email</label>
              <input
                id="email"
                type="email"
                formControlName="email"
                placeholder="mario@example.com"
                class="form-input"
                [class.error]="checkoutForm.get('email')?.invalid && checkoutForm.get('email')?.touched"
              />
              <span class="error-text" *ngIf="checkoutForm.get('email')?.invalid && checkoutForm.get('email')?.touched">
                {{ getFieldError('email') }}
              </span>
            </div>

            <div class="form-group">
              <label for="phoneNumber">Telefono</label>
              <input
                id="phoneNumber"
                type="tel"
                formControlName="phoneNumber"
                placeholder="+39 3XX XXX XXXX"
                class="form-input"
                [class.error]="checkoutForm.get('phoneNumber')?.invalid && checkoutForm.get('phoneNumber')?.touched"
              />
              <span class="error-text" *ngIf="checkoutForm.get('phoneNumber')?.invalid && checkoutForm.get('phoneNumber')?.touched">
                {{ getFieldError('phoneNumber') }}
              </span>
            </div>
          </fieldset>

          <!-- Indirizzo di Consegna -->
          <fieldset class="form-section">
            <legend>üìç Indirizzo di Consegna</legend>

            <div class="form-group">
              <label for="deliveryAddress">Indirizzo</label>
              <input
                id="deliveryAddress"
                type="text"
                formControlName="deliveryAddress"
                placeholder="Via Roma 123"
                class="form-input"
                [class.error]="checkoutForm.get('deliveryAddress')?.invalid && checkoutForm.get('deliveryAddress')?.touched"
              />
              <span class="error-text" *ngIf="checkoutForm.get('deliveryAddress')?.invalid && checkoutForm.get('deliveryAddress')?.touched">
                {{ getFieldError('deliveryAddress') }}
              </span>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">Citt√†</label>
                <input
                  id="city"
                  type="text"
                  formControlName="city"
                  placeholder="Roma"
                  class="form-input"
                  [class.error]="checkoutForm.get('city')?.invalid && checkoutForm.get('city')?.touched"
                />
                <span class="error-text" *ngIf="checkoutForm.get('city')?.invalid && checkoutForm.get('city')?.touched">
                  {{ getFieldError('city') }}
                </span>
              </div>

              <div class="form-group">
                <label for="postalCode">CAP</label>
                <input
                  id="postalCode"
                  type="text"
                  formControlName="postalCode"
                  placeholder="00100"
                  class="form-input"
                  [class.error]="checkoutForm.get('postalCode')?.invalid && checkoutForm.get('postalCode')?.touched"
                />
                <span class="error-text" *ngIf="checkoutForm.get('postalCode')?.invalid && checkoutForm.get('postalCode')?.touched">
                  {{ getFieldError('postalCode') }}
                </span>
              </div>
            </div>
          </fieldset>

          <!-- Metodo di Pagamento -->
          <fieldset class="form-section">
            <legend>üí≥ Metodo di Pagamento</legend>

            <div class="payment-methods">
              <label class="payment-option">
                <input type="radio" formControlName="paymentMethod" value="card" />
                <span class="payment-label">Carta di Credito</span>
              </label>
              <label class="payment-option">
                <input type="radio" formControlName="paymentMethod" value="paypal" />
                <span class="payment-label">PayPal</span>
              </label>
              <label class="payment-option">
                <input type="radio" formControlName="paymentMethod" value="cash" />
                <span class="payment-label">Contanti alla Consegna</span>
              </label>
            </div>

            <!-- Dati Carta -->
            <div *ngIf="checkoutForm.get('paymentMethod')?.value === 'card'" class="card-details">
              <div class="form-group">
                <label for="cardNumber">Numero Carta</label>
                <input
                  id="cardNumber"
                  type="text"
                  formControlName="cardNumber"
                  placeholder="1234 5678 9012 3456"
                  class="form-input"
                  maxlength="19"
                  [class.error]="checkoutForm.get('cardNumber')?.invalid && checkoutForm.get('cardNumber')?.touched"
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="cardExpiry">Data Scadenza</label>
                  <input
                    id="cardExpiry"
                    type="text"
                    formControlName="cardExpiry"
                    placeholder="MM/YY"
                    class="form-input"
                    maxlength="5"
                    [class.error]="checkoutForm.get('cardExpiry')?.invalid && checkoutForm.get('cardExpiry')?.touched"
                  />
                </div>

                <div class="form-group">
                  <label for="cardCvv">CVV</label>
                  <input
                    id="cardCvv"
                    type="text"
                    formControlName="cardCvv"
                    placeholder="123"
                    class="form-input"
                    maxlength="4"
                    [class.error]="checkoutForm.get('cardCvv')?.invalid && checkoutForm.get('cardCvv')?.touched"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="cardName">Titolare Carta</label>
                <input
                  id="cardName"
                  type="text"
                  formControlName="cardName"
                  placeholder="Mario Rossi"
                  class="form-input"
                  [class.error]="checkoutForm.get('cardName')?.invalid && checkoutForm.get('cardName')?.touched"
                />
              </div>
            </div>
          </fieldset>

          <!-- Note Aggiuntive -->
          <fieldset class="form-section">
            <legend>üìù Note Aggiuntive</legend>

            <div class="form-group">
              <label for="notes">Istruzioni di Consegna (opzionale)</label>
              <textarea
                id="notes"
                formControlName="notes"
                placeholder="Es. Suonare il campanello, lasciare davanti alla porta..."
                rows="3"
                class="form-input"
              ></textarea>
            </div>
          </fieldset>

          <!-- Termini -->
          <div class="form-group checkbox">
            <input
              id="agreeTerms"
              type="checkbox"
              formControlName="agreeTerms"
              [class.error]="checkoutForm.get('agreeTerms')?.invalid && checkoutForm.get('agreeTerms')?.touched"
            />
            <label for="agreeTerms">
              Accetto i termini e le condizioni di servizio *
            </label>
          </div>

          <!-- Pulsanti -->
          <div class="form-actions">
            <button
              type="button"
              (click)="goBackToOrder()"
              class="btn-secondary"
              [disabled]="isProcessing"
            >
              ‚Üê Torna ai Piatti
            </button>
            <button
              type="button"
              (click)="placeOrder()"
              class="btn-primary"
              [disabled]="!isFormValid()"
            >
              <span *ngIf="!isProcessing">Conferma Ordine</span>
              <span *ngIf="isProcessing">Elaborazione...</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Colonna Destra: Riepilogo Ordine -->
      <aside class="order-summary-section">
        <div class="order-summary">
          <h2>üìã Riepilogo Ordine</h2>

          <div class="summary-items">
            <div class="summary-item" *ngFor="let item of cart.items">
              <div class="item-name">
                <strong>{{ item.product.name }}</strong>
                <span class="item-qty">x{{ item.quantity }}</span>
              </div>
              <div class="item-price">
                ‚Ç¨{{ (item.product.price * item.quantity).toFixed(2) }}
              </div>
            </div>
          </div>

          <div class="summary-divider"></div>

          <div class="summary-totals">
            <div class="summary-row">
              <span>Subtotale</span>
              <span>‚Ç¨{{ cart.totalPrice.toFixed(2) }}</span>
            </div>

            <div class="summary-row">
              <span>Consegna</span>
              <span [class.free]="getDeliveryFee() === 0">
                <span *ngIf="getDeliveryFee() === 0">Gratis</span>
                <span *ngIf="getDeliveryFee() > 0">‚Ç¨{{ getDeliveryFee().toFixed(2) }}</span>
              </span>
            </div>

            <div class="summary-row total">
              <span>Totale</span>
              <span>‚Ç¨{{ getTotalPrice().toFixed(2) }}</span>
            </div>
          </div>

          <div class="summary-info">
            <p>‚úì Pagamento sicuro con SSL</p>
            <p>‚úì Consegna entro 30 minuti</p>
            <p>‚úì Supporto 24/7</p>
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>